$SIZES LIM6=4000 LTH=-1000 DIMNEW=-10000
$PROBLEM
$INPUT ID TIME DAY ITEM DV
$DATA /mnt/data/code/PRO_Tutorial/data/Analysis_Data_nm.csv IGNORE=@

$PRED
;-------------------------constants to select model type-------------------------
PSI_MODEL=0
UNDEF=0
OC1=1    ; ordered categorical [1,4]

;-------------------------assignment of item parameters--------------------------
IF(ITEM.EQ.1) THEN
    MODEL=OC1
    DIS=THETA(1)
    DIF1=THETA(2)
    DIF2=THETA(3)
    DIF3=THETA(4)
ELSE IF(ITEM.EQ.2) THEN
    MODEL=OC1
    DIS=THETA(5)
    DIF1=THETA(6)
    DIF2=THETA(7)
    DIF3=THETA(8)
ELSE IF(ITEM.EQ.3) THEN
    MODEL=OC1
    DIS=THETA(9)
    DIF1=THETA(10)
    DIF2=THETA(11)
    DIF3=THETA(12)
ELSE IF(ITEM.EQ.4) THEN
    MODEL=OC1
    DIS=THETA(13)
    DIF1=THETA(14)
    DIF2=THETA(15)
    DIF3=THETA(16)
ELSE IF(ITEM.EQ.5) THEN
    MODEL=OC1
    DIS=THETA(17)
    DIF1=THETA(18)
    DIF2=THETA(19)
    DIF3=THETA(20)
ELSE IF(ITEM.EQ.6) THEN
    MODEL=OC1
    DIS=THETA(21)
    DIF1=THETA(22)
    DIF2=THETA(23)
    DIF3=THETA(24)
ELSE IF(ITEM.EQ.7) THEN
    MODEL=OC1
    DIS=THETA(25)
    DIF1=THETA(26)
    DIF2=THETA(27)
    DIF3=THETA(28)
ELSE IF(ITEM.EQ.8) THEN
    MODEL=OC1
    DIS=THETA(29)
    DIF1=THETA(30)
    DIF2=THETA(31)
    DIF3=THETA(32)
ELSE IF(ITEM.EQ.9) THEN
    MODEL=OC1
    DIS=THETA(33)
    DIF1=THETA(34)
    DIF2=THETA(35)
    DIF3=THETA(36)
ELSE IF(ITEM.EQ.10) THEN
    MODEL=OC1
    DIS=THETA(37)
    DIF1=THETA(38)
    DIF2=THETA(39)
    DIF3=THETA(40)
ELSE IF(ITEM.EQ.11) THEN
    MODEL=OC1
    DIS=THETA(41)
    DIF1=THETA(42)
    DIF2=THETA(43)
    DIF3=THETA(44)
ELSE IF(ITEM.EQ.12) THEN
    MODEL=OC1
    DIS=THETA(45)
    DIF1=THETA(46)
    DIF2=THETA(47)
    DIF3=THETA(48)
ELSE IF(ITEM.EQ.13) THEN
    MODEL=OC1
    DIS=THETA(49)
    DIF1=THETA(50)
    DIF2=THETA(51)
    DIF3=THETA(52)
ELSE IF(ITEM.EQ.14) THEN
    MODEL=OC1
    DIS=THETA(53)
    DIF1=THETA(54)
    DIF2=THETA(55)
    DIF3=THETA(56)
ELSE IF(ITEM.EQ.15) THEN
    MODEL=OC1
    DIS=THETA(57)
    DIF1=THETA(58)
    DIF2=THETA(59)
    DIF3=THETA(60)
ELSE IF(ITEM.EQ.16) THEN
    MODEL=OC1
    DIS=THETA(61)
    DIF1=THETA(62)
    DIF2=THETA(63)
    DIF3=THETA(64)
ELSE IF(ITEM.EQ.17) THEN
    MODEL=OC1
    DIS=THETA(65)
    DIF1=THETA(66)
    DIF2=THETA(67)
    DIF3=THETA(68)
ELSE IF(ITEM.EQ.18) THEN
    MODEL=OC1
    DIS=THETA(69)
    DIF1=THETA(70)
    DIF2=THETA(71)
    DIF3=THETA(72)
ELSE IF(ITEM.EQ.19) THEN
    MODEL=OC1
    DIS=THETA(73)
    DIF1=THETA(74)
    DIF2=THETA(75)
    DIF3=THETA(76)
ELSE IF(ITEM.EQ.20) THEN
    MODEL=OC1
    DIS=THETA(77)
    DIF1=THETA(78)
    DIF2=THETA(79)
    DIF3=THETA(80)
ELSE IF(ITEM.EQ.21) THEN
    MODEL=OC1
    DIS=THETA(81)
    DIF1=THETA(82)
    DIF2=THETA(83)
    DIF3=THETA(84)
ELSE IF(ITEM.EQ.22) THEN
    MODEL=OC1
    DIS=THETA(85)
    DIF1=THETA(86)
    DIF2=THETA(87)
    DIF3=THETA(88)
ELSE IF(ITEM.EQ.23) THEN
    MODEL=OC1
    DIS=THETA(89)
    DIF1=THETA(90)
    DIF2=THETA(91)
    DIF3=THETA(92)
ELSE IF(ITEM.EQ.24) THEN
    MODEL=OC1
    DIS=THETA(93)
    DIF1=THETA(94)
    DIF2=THETA(95)
    DIF3=THETA(96)
ELSE IF(ITEM.EQ.25) THEN
    MODEL=OC1
    DIS=THETA(97)
    DIF1=THETA(98)
    DIF2=THETA(99)
    DIF3=THETA(100)
ELSE IF(ITEM.EQ.26) THEN
    MODEL=OC1
    DIS=THETA(101)
    DIF1=THETA(102)
    DIF2=THETA(103)
    DIF3=THETA(104)
ELSE IF(ITEM.EQ.27) THEN
    MODEL=OC1
    DIS=THETA(105)
    DIF1=THETA(106)
    DIF2=THETA(107)
    DIF3=THETA(108)
ELSE
    MODEL=UNDEF
    PPRED=0
    SDPRED=0
    P=0
    P0=0
    P1=0
    P2=0
    P3=0
    P4=0
    PGE1=0
    PGE2=0
    PGE3=0
    PGE4=0
END IF

;-------------------------The latent variable model------------------------------

PSI=THETA(109)+ETA(1)

;-------------------------ordered categorical data model with 4 levels: [1,4]----
IF(MODEL.EQ.OC1) THEN
    DIFG1=DIF1
    DIFG2=DIFG1+DIF2
    DIFG3=DIFG2+DIF3

    PGE1=EXP(DIS*(PSI-DIFG1))/(1+EXP(DIS*(PSI-DIFG1)))
    PGE2=EXP(DIS*(PSI-DIFG2))/(1+EXP(DIS*(PSI-DIFG2)))
    PGE3=EXP(DIS*(PSI-DIFG3))/(1+EXP(DIS*(PSI-DIFG3)))

    P1=1-PGE1
    P2=PGE1-PGE2
    P3=PGE2-PGE3
    P4=PGE3

    PPRED=P1*1 + P2*2 + P3*3 + P4*4
    SDPRED=SQRT(P1*(1-PPRED)**2 + P2*(2-PPRED)**2 + P3*(3-PPRED)**2 + P4*(4-PPRED)**2)
ENDIF

IF(MODEL.EQ.OC1.AND.DV.LE.1) P=P1
IF(MODEL.EQ.OC1.AND.DV.EQ.2) P=P2
IF(MODEL.EQ.OC1.AND.DV.EQ.3) P=P3
IF(MODEL.EQ.OC1.AND.DV.GE.4) P=P4

;-------------------------Response probability prediction and residual-----------
IF(P.LT.1E-16) P=1E-16  ; To protect for P->0
IF(P.GT.(1-1E-16)) P=1-1E-16  ; To protect for P->1
Y=-2*LOG(P)
PWRES = (DV - PPRED) / SDPRED

IF (MODEL.EQ.UNDEF) THEN
    PWRES=0
    P=0
    Y=0
ENDIF

;-------------------------simulation code----------------------------------------
IF(ICALL.EQ.4) THEN
    IF(MODEL.EQ.OC1) THEN
        CALL RANDOM(2, R)
        SDV=1
        IF(R.LT.PGE1) SDV=2
        IF(R.LT.PGE2) SDV=3
        IF(R.LT.PGE3) SDV=4
    ENDIF

    DV=SDV
ENDIF

;-------------------------estimation task----------------------------------------
;Sim_start for VPC
$ESTIMATION METHOD=COND LAPLACE -2LL MAXEVAL=999999 PRINT=1 
;$SIMULATION (1995152104) (1827006284 UNI) ONLYSIM NOPRED
;Sim_end for VPC
$TABLE ID TIME DV ITEM PSI PPRED PWRES DIF1 DIF2 DIF3 DIS DIFG1 DIFG2 DIFG3 VARCALC=1 FILE=irt_tab1 NOAPPEND ONEHEADER NOPRINT
$TABLE ID TIME DV ITEM P0 P1 P2 P3 P4 FILE=prob_tab1 NOAPPEND ONEHEADER NOPRINT

;-------------------------random effects-----------------------------------------
$OMEGA 1 FIX

$THETA
;-------------------------item parameters----------------------------------------
(0,2.11919942358664) ; I1DIS 1
-0.750187969933952 ; I1DIF1 2
(0,1.48612962347889,50) ; I1DIF2 3
(0,1.1394112866448,50) ; I1DIF3 4
(0,2.30696011104003) ; I2DIS 5
-0.617579598457802 ; I2DIF1 6
(0,1.33591127085466,50) ; I2DIF2 7
(0,1.04059055418162,50) ; I2DIF3 8
(0,2.00547830114989) ; I3DIS 9
0.670719613382153 ; I3DIF1 10
(0,1.32989337741306,50) ; I3DIF2 11
(0,0.912303832455119,50) ; I3DIF3 12
(0,2.05246099785104) ; I4DIS 13
0.196069090441457 ; I4DIF1 14
(0,1.40848285923436,50) ; I4DIF2 15
(0,1.06795604846236,50) ; I4DIF3 16
(0,1.87279981247643) ; I5DIS 17
1.82233924676434 ; I5DIF1 18
(0,1.09201375182575,50) ; I5DIF2 19
(0,0.869102020869581,50) ; I5DIF3 20
(0,3.35919934869294) ; I6DIS 21
-0.22163089251526 ; I6DIF1 22
(0,1.30666379687741,50) ; I6DIF2 23
(0,0.865802681259118,50) ; I6DIF3 24
(0,2.9925147679496) ; I7DIS 25
-0.126576914709098 ; I7DIF1 26
(0,1.17948672481877,50) ; I7DIF2 27
(0,0.895497532704959,50) ; I7DIF3 28
(0,1.35774739147325) ; I8DIS 29
0.339625714031541 ; I8DIF1 30
(0,1.68089608542134,50) ; I8DIF2 31
(0,1.41684516955753,50) ; I8DIF3 32
(0,1.46165270063486) ; I9DIS 33
-0.273808832136231 ; I9DIF1 34
(0,1.65639229262929,50) ; I9DIF2 35
(0,1.08875286947448,50) ; I9DIF3 36
(0,3.00893722887866) ; I10DIS 37
-0.747890729946756 ; I10DIF1 38
(0,1.50127935960296,50) ; I10DIF2 39
(0,1.07622037460901,50) ; I10DIF3 40
(0,1.04310417200549) ; I11DIS 41
-0.223596534659573 ; I11DIF1 42
(0,2.08287960163495,50) ; I11DIF2 43
(0,1.3720424750911,50) ; I11DIF3 44
(0,3.24474787961393) ; I12DIS 45
-0.249595806106237 ; I12DIF1 46
(0,1.30109086880165,50) ; I12DIF2 47
(0,0.91704519624357,50) ; I12DIF3 48
(0,1.73394259485642) ; I13DIS 49
0.528930180303847 ; I13DIF1 50
(0,1.07279086633889,50) ; I13DIF2 51
(0,0.896220412798845,50) ; I13DIF3 52
(0,1.18745779998944) ; I14DIS 53
0.63549598846455 ; I14DIF1 54
(0,1.90681817312965,50) ; I14DIF2 55
(0,1.32579557594069,50) ; I14DIF3 56
(0,1.26848028666469) ; I15DIS 57
1.81148865543822 ; I15DIF1 58
(0,1.37611890192565,50) ; I15DIF2 59
(0,0.850352637162648,50) ; I15DIF3 60
(0,0.832631342698732) ; I16DIS 61
1.33434134240881 ; I16DIF1 62
(0,2.07365961374134,50) ; I16DIF2 63
(0,1.56215446338029,50) ; I16DIF3 64
(0,0.723538218259517) ; I17DIS 65
0.969089177810419 ; I17DIF1 66
(0,2.33598556361717,50) ; I17DIF2 67
(0,2.42698853105523,50) ; I17DIF3 68
(0,2.88126507671286) ; I18DIS 69
-0.884134929936846 ; I18DIF1 70
(0,1.66899875222292,50) ; I18DIF2 71
(0,1.02364379322055,50) ; I18DIF3 72
(0,1.95570722009221) ; I19DIS 73
0.213167653260558 ; I19DIF1 74
(0,1.17721149767588,50) ; I19DIF2 75
(0,0.972351343899573,50) ; I19DIF3 76
(0,1.89641477666146) ; I20DIS 77
0.650412508384523 ; I20DIF1 78
(0,1.41004692896732,50) ; I20DIF2 79
(0,1.01233554518421,50) ; I20DIF3 80
(0,1.29692985141118) ; I21DIS 81
-0.146964841571287 ; I21DIF1 82
(0,2.05961063493061,50) ; I21DIF2 83
(0,1.71279569856191,50) ; I21DIF3 84
(0,1.33145414350737) ; I22DIS 85
-0.824268901152263 ; I22DIF1 86
(0,2.08793844308744,50) ; I22DIF2 87
(0,1.55149350060732,50) ; I22DIF3 88
(0,1.28744531881492) ; I23DIS 89
0.0727027069231882 ; I23DIF1 90
(0,2.01588391178576,50) ; I23DIF2 91
(0,1.50842849916595,50) ; I23DIF3 92
(0,1.4814264868787) ; I24DIS 93
0.0188708789597758 ; I24DIF1 94
(0,1.67906478064666,50) ; I24DIF2 95
(0,1.3879399728379,50) ; I24DIF3 96
(0,1.16383620161516) ; I25DIS 97
0.268587908945318 ; I25DIF1 98
(0,2.25582682348639,50) ; I25DIF2 99
(0,1.40162896609369,50) ; I25DIF3 100
(0,2.14295559832306) ; I26DIS 101
0.0680037326214694 ; I26DIF1 102
(0,1.4256890177595,50) ; I26DIF2 103
(0,1.07943487161042,50) ; I26DIF3 104
(0,2.69653312663248) ; I27DIS 105
-0.073252405547322 ; I27DIF1 106
(0,1.16182918585448,50) ; I27DIF2 107
(0,0.921021712253533,50) ; I27DIF3 108

;-------------------------latent variable model parameters-----------------------
0 FIX

