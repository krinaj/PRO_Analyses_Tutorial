$SIZES LIM6=4000 LTH=-1000 DIMNEW=-10000
$PROBLEM
$INPUT ID TIME DAY ITEM DV
$DATA /mnt/data/code/PRO_Tutorial/data/Analysis_Data_nm.csv IGNORE=@

$PRED
;-------------------------constants to select model type-------------------------
PSI_MODEL=0
UNDEF=0
OC1=1    ; ordered categorical [1,4]

;-------------------------assignment of item parameters--------------------------
IF(ITEM.EQ.1) THEN
    MODEL=OC1
    DIS=THETA(1)
    DIF1=THETA(2)
    DIF2=THETA(3)
    DIF3=THETA(4)
ELSE IF(ITEM.EQ.2) THEN
    MODEL=OC1
    DIS=THETA(5)
    DIF1=THETA(6)
    DIF2=THETA(7)
    DIF3=THETA(8)
ELSE IF(ITEM.EQ.3) THEN
    MODEL=OC1
    DIS=THETA(9)
    DIF1=THETA(10)
    DIF2=THETA(11)
    DIF3=THETA(12)
ELSE IF(ITEM.EQ.4) THEN
    MODEL=OC1
    DIS=THETA(13)
    DIF1=THETA(14)
    DIF2=THETA(15)
    DIF3=THETA(16)
ELSE IF(ITEM.EQ.5) THEN
    MODEL=OC1
    DIS=THETA(17)
    DIF1=THETA(18)
    DIF2=THETA(19)
    DIF3=THETA(20)
ELSE IF(ITEM.EQ.6) THEN
    MODEL=OC1
    DIS=THETA(21)
    DIF1=THETA(22)
    DIF2=THETA(23)
    DIF3=THETA(24)
ELSE IF(ITEM.EQ.7) THEN
    MODEL=OC1
    DIS=THETA(25)
    DIF1=THETA(26)
    DIF2=THETA(27)
    DIF3=THETA(28)
ELSE IF(ITEM.EQ.8) THEN
    MODEL=OC1
    DIS=THETA(29)
    DIF1=THETA(30)
    DIF2=THETA(31)
    DIF3=THETA(32)
ELSE IF(ITEM.EQ.9) THEN
    MODEL=OC1
    DIS=THETA(33)
    DIF1=THETA(34)
    DIF2=THETA(35)
    DIF3=THETA(36)
ELSE IF(ITEM.EQ.10) THEN
    MODEL=OC1
    DIS=THETA(37)
    DIF1=THETA(38)
    DIF2=THETA(39)
    DIF3=THETA(40)
ELSE IF(ITEM.EQ.11) THEN
    MODEL=OC1
    DIS=THETA(41)
    DIF1=THETA(42)
    DIF2=THETA(43)
    DIF3=THETA(44)
ELSE IF(ITEM.EQ.12) THEN
    MODEL=OC1
    DIS=THETA(45)
    DIF1=THETA(46)
    DIF2=THETA(47)
    DIF3=THETA(48)
ELSE IF(ITEM.EQ.13) THEN
    MODEL=OC1
    DIS=THETA(49)
    DIF1=THETA(50)
    DIF2=THETA(51)
    DIF3=THETA(52)
ELSE IF(ITEM.EQ.14) THEN
    MODEL=OC1
    DIS=THETA(53)
    DIF1=THETA(54)
    DIF2=THETA(55)
    DIF3=THETA(56)
ELSE IF(ITEM.EQ.15) THEN
    MODEL=OC1
    DIS=THETA(57)
    DIF1=THETA(58)
    DIF2=THETA(59)
    DIF3=THETA(60)
ELSE IF(ITEM.EQ.16) THEN
    MODEL=OC1
    DIS=THETA(61)
    DIF1=THETA(62)
    DIF2=THETA(63)
    DIF3=THETA(64)
ELSE IF(ITEM.EQ.17) THEN
    MODEL=OC1
    DIS=THETA(65)
    DIF1=THETA(66)
    DIF2=THETA(67)
    DIF3=THETA(68)
ELSE IF(ITEM.EQ.18) THEN
    MODEL=OC1
    DIS=THETA(69)
    DIF1=THETA(70)
    DIF2=THETA(71)
    DIF3=THETA(72)
ELSE IF(ITEM.EQ.19) THEN
    MODEL=OC1
    DIS=THETA(73)
    DIF1=THETA(74)
    DIF2=THETA(75)
    DIF3=THETA(76)
ELSE IF(ITEM.EQ.20) THEN
    MODEL=OC1
    DIS=THETA(77)
    DIF1=THETA(78)
    DIF2=THETA(79)
    DIF3=THETA(80)
ELSE IF(ITEM.EQ.21) THEN
    MODEL=OC1
    DIS=THETA(81)
    DIF1=THETA(82)
    DIF2=THETA(83)
    DIF3=THETA(84)
ELSE IF(ITEM.EQ.22) THEN
    MODEL=OC1
    DIS=THETA(85)
    DIF1=THETA(86)
    DIF2=THETA(87)
    DIF3=THETA(88)
ELSE IF(ITEM.EQ.23) THEN
    MODEL=OC1
    DIS=THETA(89)
    DIF1=THETA(90)
    DIF2=THETA(91)
    DIF3=THETA(92)
ELSE IF(ITEM.EQ.24) THEN
    MODEL=OC1
    DIS=THETA(93)
    DIF1=THETA(94)
    DIF2=THETA(95)
    DIF3=THETA(96)
ELSE IF(ITEM.EQ.25) THEN
    MODEL=OC1
    DIS=THETA(97)
    DIF1=THETA(98)
    DIF2=THETA(99)
    DIF3=THETA(100)
ELSE IF(ITEM.EQ.26) THEN
    MODEL=OC1
    DIS=THETA(101)
    DIF1=THETA(102)
    DIF2=THETA(103)
    DIF3=THETA(104)
ELSE IF(ITEM.EQ.27) THEN
    MODEL=OC1
    DIS=THETA(105)
    DIF1=THETA(106)
    DIF2=THETA(107)
    DIF3=THETA(108)
ELSE
    MODEL=UNDEF
    PPRED=0
    SDPRED=0
    P=0
    P0=0
    P1=0
    P2=0
    P3=0
    P4=0
    PGE1=0
    PGE2=0
    PGE3=0
    PGE4=0
END IF

;-------------------------The latent variable model------------------------------

BasePSI = THETA(109) + ETA(1)

TMSLP = THETA(110) + ETA(2)

PSI = BasePSI + TMSLP*TIME 

;-------------------------ordered categorical data model with 4 levels: [1,4]----
IF(MODEL.EQ.OC1) THEN
    DIFG1=DIF1
    DIFG2=DIFG1+DIF2
    DIFG3=DIFG2+DIF3

    PGE1=EXP(DIS*(PSI-DIFG1))/(1+EXP(DIS*(PSI-DIFG1)))
    PGE2=EXP(DIS*(PSI-DIFG2))/(1+EXP(DIS*(PSI-DIFG2)))
    PGE3=EXP(DIS*(PSI-DIFG3))/(1+EXP(DIS*(PSI-DIFG3)))

    P1=1-PGE1
    P2=PGE1-PGE2
    P3=PGE2-PGE3
    P4=PGE3

    PPRED=P1*1 + P2*2 + P3*3 + P4*4
    SDPRED=SQRT(P1*(1-PPRED)**2 + P2*(2-PPRED)**2 + P3*(3-PPRED)**2 + P4*(4-PPRED)**2)
ENDIF

IF(MODEL.EQ.OC1.AND.DV.LE.1) P=P1
IF(MODEL.EQ.OC1.AND.DV.EQ.2) P=P2
IF(MODEL.EQ.OC1.AND.DV.EQ.3) P=P3
IF(MODEL.EQ.OC1.AND.DV.GE.4) P=P4

;-------------------------Response probability prediction and residual-----------
IF(P.LT.1E-16) P=1E-16  ; To protect for P->0
IF(P.GT.(1-1E-16)) P=1-1E-16  ; To protect for P->1
Y=-2*LOG(P)
PWRES = (DV - PPRED) / SDPRED

IF (MODEL.EQ.UNDEF) THEN
    PWRES=0
    P=0
    Y=0
ENDIF

;-------------------------simulation code----------------------------------------
IF(ICALL.EQ.4) THEN
    IF(MODEL.EQ.OC1) THEN
        CALL RANDOM(2, R)
        SDV=1
        IF(R.LT.PGE1) SDV=2
        IF(R.LT.PGE2) SDV=3
        IF(R.LT.PGE3) SDV=4
    ENDIF

    DV=SDV
ENDIF

;-------------------------estimation task----------------------------------------
;Sim_start for VPC
$ESTIMATION METHOD=COND LAPLACE -2LL MAXEVAL=999999 PRINT=1 
;$SIMULATION (2080178325) (1517856924 UNI) ONLYSIM NOPRED
;Sim_end for VPC
$TABLE ID TIME DV ITEM PSI PPRED PWRES DIF1 DIF2 DIF3 DIS DIFG1 DIFG2 DIFG3 VARCALC=1 FILE=irt_tab2 NOAPPEND ONEHEADER NOPRINT
$TABLE ID TIME DV ITEM P0 P1 P2 P3 P4 FILE=prob_tab2 NOAPPEND ONEHEADER NOPRINT

;-------------------------random effects-----------------------------------------
$OMEGA 1 FIX ; IIV Baseline PSI 
$OMEGA 0.09 ; IIV Slope

$THETA
;-------------------------item parameters----------------------------------------
1.9343 FIX ; I1DIS 1
-0.9386 FIX ; I1DIF1 2
1.543 FIX ; I1DIF2 3
1.1282 FIX ; I1DIF3 4
2.0591 FIX ; I2DIS 5
-0.80436 FIX ; I2DIF1 6
1.3819 FIX ; I2DIF2 7
1.0301 FIX ; I2DIF3 8
1.64 FIX ; I3DIS 9
0.57483 FIX ; I3DIF1 10
1.4147 FIX ; I3DIF2 11
0.93171 FIX ; I3DIF3 12
1.8011 FIX ; I4DIS 13
0.043665 FIX ; I4DIF1 14
1.4698 FIX ; I4DIF2 15
1.0472 FIX ; I4DIF3 16
1.7653 FIX ; I5DIS 17
1.6794 FIX ; I5DIF1 18
1.0895 FIX ; I5DIF2 19
0.8431 FIX ; I5DIF3 20
2.1411 FIX ; I6DIS 21
-0.41202 FIX ; I6DIF1 22
1.4726 FIX ; I6DIF2 23
0.90745 FIX ; I6DIF3 24
2.0531 FIX ; I7DIS 25
-0.29925 FIX ; I7DIF1 26
1.3089 FIX ; I7DIF2 27
0.94174 FIX ; I7DIF3 28
1.3268 FIX ; I8DIS 29
0.18045 FIX ; I8DIF1 30
1.6728 FIX ; I8DIF2 31
1.4203 FIX ; I8DIF3 32
1.3237 FIX ; I9DIS 33
-0.4513 FIX ; I9DIF1 34
1.7426 FIX ; I9DIF2 35
1.1219 FIX ; I9DIF3 36
2.1831 FIX ; I10DIS 37
-1.0032 FIX ; I10DIF1 38
1.6815 FIX ; I10DIF2 39
1.1204 FIX ; I10DIF3 40
0.87314 FIX ; I11DIS 41
-0.431 FIX ; I11DIF1 42
2.3757 FIX ; I11DIF2 43
1.5462 FIX ; I11DIF3 44
2.1039 FIX ; I12DIS 45
-0.44468 FIX ; I12DIF1 46
1.4688 FIX ; I12DIF2 47
0.98064 FIX ; I12DIF3 48
1.3362 FIX ; I13DIS 49
0.44736 FIX ; I13DIF1 50
1.2087 FIX ; I13DIF2 51
0.98346 FIX ; I13DIF3 52
0.96244 FIX ; I14DIS 53
0.5686 FIX ; I14DIF1 54
2.2 FIX ; I14DIF2 55
1.542 FIX ; I14DIF3 56
1.1145 FIX ; I15DIS 57
1.7848 FIX ; I15DIF1 58
1.5021 FIX ; I15DIF2 59
0.93173 FIX ; I15DIF3 60
0.79486 FIX ; I16DIS 61
1.2051 FIX ; I16DIF1 62
2.1395 FIX ; I16DIF2 63
1.6253 FIX ; I16DIF3 64
0.61997 FIX ; I17DIS 65
0.9384 FIX ; I17DIF1 66
2.6624 FIX ; I17DIF2 67
2.7833 FIX ; I17DIF3 68
2.1159 FIX ; I18DIS 69
-1.1499 FIX ; I18DIF1 70
1.8477 FIX ; I18DIF2 71
1.0594 FIX ; I18DIF3 72
1.5629 FIX ; I19DIS 73
0.083552 FIX ; I19DIF1 74
1.2959 FIX ; I19DIF2 75
1.034 FIX ; I19DIF3 76
1.553 FIX ; I20DIS 77
0.55378 FIX ; I20DIF1 78
1.5138 FIX ; I20DIF2 79
1.0564 FIX ; I20DIF3 80
1.0599 FIX ; I21DIS 81
-0.33688 FIX ; I21DIF1 82
2.3351 FIX ; I21DIF2 83
1.9377 FIX ; I21DIF3 84
1.1043 FIX ; I22DIS 85
-1.0981 FIX ; I22DIF1 86
2.3496 FIX ; I22DIF2 87
1.7257 FIX ; I22DIF3 88
1.0674 FIX ; I23DIS 89
-0.084291 FIX ; I23DIF1 90
2.2709 FIX ; I23DIF2 91
1.7191 FIX ; I23DIF3 92
1.1789 FIX ; I24DIS 93
-0.14623 FIX ; I24DIF1 94
1.9127 FIX ; I24DIF2 95
1.5673 FIX ; I24DIF3 96
1.1455 FIX ; I25DIS 97
0.10211 FIX ; I25DIF1 98
2.2656 FIX ; I25DIF2 99
1.381 FIX ; I25DIF3 100
1.6471 FIX ; I26DIS 101
-0.084875 FIX ; I26DIF1 102
1.5771 FIX ; I26DIF2 103
1.1614 FIX ; I26DIF3 104
1.9699 FIX ; I27DIS 105
-0.24135 FIX ; I27DIF1 106
1.2976 FIX ; I27DIF2 107
0.96061 FIX ; I27DIF3 108

;-------------------------latent variable model parameters-----------------------
0 FIX ; Baseline PSI 
0.001 ; Slope (1/week)
